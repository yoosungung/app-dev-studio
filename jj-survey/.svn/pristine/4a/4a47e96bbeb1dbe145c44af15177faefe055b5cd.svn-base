<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<div class="page-body ${surveyDefinition.surveyTheme}"
    xmlns:jsp="http://java.sun.com/JSP/Page"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:spring="http://www.springframework.org/tags"
    xmlns:form="http://www.springframework.org/tags/form"
    xmlns:fn="http://java.sun.com/jsp/jstl/functions"
    xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
    xmlns:tiles="http://tiles.apache.org/tags-tiles"
    version="2.0">

    <jsp:directive.page contentType="text/html;charset=UTF-8"/>
    <jsp:output omit-xml-declaration="yes"/>

    <style type="text/css">
    table.questions {
        min-width: 100%;
    }
    table.questions th {
        text-align: center;
    }
    table.questions th, td {
        padding: 5px;
    }
    table.questions td.tac {
        text-align: center;
    }
    table.questions label {
        display: inline;
        cursor: pointer;
        margin-bottom: 0px;
        width: 100%;
    }
    table.questions td.tac label {
        display: block;
    }
    table.questions input[type="radio"] {
        position: relative;
        opacity: 1;
        left: auto;
        margin: 0px 4px 0px 4px;
    }
    table.questions input[type="text"] {
        width: 100%;
    }

    div.valid-checker {
        color: red;
    }

    div.row {
        padding-left: 20px;
        padding-right: 20px;
    }
    </style>

    <script type="text/javascript" src="${pageContext.request.contextPath}/shared/common/lib/bluebird/bluebird.min.js"><!----></script>
    <script type="text/javascript" src="${pageContext.request.contextPath}/shared/common/lib/vue/vue.js"><!----></script>
    <script type="text/javascript" src="${pageContext.request.contextPath}/shared/common/lib/axios/axios.js"><!----></script>

    <script type="text/javascript" src="${pageContext.request.contextPath}/shared/common/util/CommonUtil.js"><!----></script>
    <script type="text/javascript" src="${pageContext.request.contextPath}/shared/common/util/TextUtil.js"><!----></script>
    <script type="text/javascript" src="${pageContext.request.contextPath}/shared/common/util/ValidationUtil.js"><!----></script>
    <script type="text/javascript" src="${pageContext.request.contextPath}/shared/common/vue/VueComponents.js"><!----></script>

    <div class="row">
        <div class="col-lg-12 col-sm-12 col-xs-12">
            <div class="widget flat radius-bordered" style="margin: 0;">
                <div class="widget-header bg-themeprimary text-center" style="height: 60px;">
                    <span class="widget-caption" style="font-size: 22px; margin: 12px;">${survey.typeName}</span>
                </div>
            </div>
            <div class="wizard">
                <ul class="steps">
                    <li class="intro active">
                        <span class="step">0</span>설문시작<span class="chevron"><!----></span>
                    </li>
                    <c:forEach items="${surveyPages}" var="page" varStatus="loop">
                        <li class="future">
                            <span class="step">${loop.count}</span><c:out value="${page.title}"/><span class="chevron"><!----></span>
                        </li>
                    </c:forEach>
                    <li class="future">
                        <span class="step">${fn:length(surveyPages) + 1}</span>설문종료<span class="chevron"><!----></span>
                    </li>
                </ul>
            </div>
            <div id="intro" class="step-content" style="padding: 20px;">
                <div class="step-pane active">
                    <div class="form-title">
                        <span class="survey-page-no">설문 안내</span>
                    </div>
                    <div class="form-title">
                        <span class="survey-page-no">인구통계적 문항</span>
                    </div>
                    <div class="row">
                        <table class="questions" border="1">
                            <colgroup>
                                <col style="width: 80px;" />
                                <col />
                            </colgroup>
                            <tbody>
                                <tr v-if="model.tbSurveyQestnrCmmn.sexdstn === true">
                                    <th>성별</th>
                                    <td>
                                        <label v-for="row in codeData.sexdstn">
                                            <input type="radio" name="sexdstn" v-value="row.code" onclick="javascript:vues.intro.setValue(this);"></input>
                                            <span>{{ row.name }}</span>
                                        </label>
                                        <div class="valid-checker" v-if="showValidChecker(model.tbSurveyCmmnRspns.sexdstn)">필수 항목입니다.</div>
                                    </td>
                                </tr>
                                <tr v-if="model.tbSurveyQestnrCmmn.area === true">
                                    <th>지역</th>
                                    <td>
                                        <label v-for="row in codeData.area">
                                            <input type="radio" name="area" v-value="row.code" onclick="javascript:vues.intro.setValue(this);"></input>
                                            <span>{{ row.name }}</span>
                                        </label>
                                        <div class="valid-checker" v-if="showValidChecker(model.tbSurveyCmmnRspns.area)">필수 항목입니다.</div>
                                    </td>
                                </tr>
                                <tr v-if="model.tbSurveyQestnrCmmn.grade === true">
                                    <th>학년</th>
                                    <td>
                                        <label v-for="row in codeData.grade">
                                            <input type="radio" name="grade" v-value="row.code" onclick="javascript:vues.intro.setValue(this);"></input>
                                            <span>{{ row.name }}</span>
                                        </label>
                                        <div class="valid-checker" v-if="showValidChecker(model.tbSurveyCmmnRspns.grade)">필수 항목입니다.</div>
                                    </td>
                                </tr>
                                <tr v-if="model.tbSurveyQestnrCmmn.cghmy === true">
                                    <th>소속<br/>단과대학</th>
                                    <td>
                                        <label v-for="row in codeData.cghmy">
                                            <input type="radio" name="cghmy" v-value="row.code" onclick="javascript:vues.intro.setValue(this);"></input>
                                            <span>{{ row.name }}</span>
                                        </label>
                                        <div class="valid-checker" v-if="showValidChecker(model.tbSurveyCmmnRspns.cghmy)">필수 항목입니다.</div>
                                    </td>
                                </tr>
                                <tr v-if="model.tbSurveyQestnrCmmn.subjct === true">
                                    <th>학과</th>
                                    <td>
                                        <input type="text" name="subjct" v-model="model.tbSurveyCmmnRspns.subjct" onkeyup="javascript:vues.intro.setValue(this);"></input>
                                        <div class="valid-checker" v-if="showValidChecker(model.tbSurveyCmmnRspns.subjct)">필수 항목입니다.</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="form-title">
                        <span class="survey-page-no">중복설문 문항</span>
                    </div>
                    <div class="row">
                        <table class="questions" border="1">
                            <colgroup>
                                <col style="width: 80px;" />
                                <col />
                                <col style="width: 120px;" v-for="row in codeData.stsfdg" />
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>순번</th>
                                    <th>문항내용</th>
                                    <th v-for="row in codeData.stsfdg">{{ row.name }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="model.tbSurveyQestnrCmmn.stsfdg01 === true">
                                    <th>1</th>
                                    <td>
                                        <span>전주대학교에 전반적으로 만족하십니까?</span>
                                        <div class="valid-checker" v-if="showValidChecker(model.tbSurveyCmmnRspns.stsfdg01)">필수 항목입니다.</div>
                                    </td>
                                    <td class="tac" v-for="row in codeData.stsfdg">
                                        <label>
                                            <input type="radio" name="stsfdg01" v-value="row.code" onclick="javascript:vues.intro.setValue(this);"></input>
                                        </label>
                                    </td>
                                </tr>
                                <tr v-if="model.tbSurveyQestnrCmmn.stsfdg02 === true">
                                    <th>2</th>
                                    <td>
                                        <span>전주대학교의 교육에 대해 만족하십니까?</span>
                                        <div class="valid-checker" v-if="showValidChecker(model.tbSurveyCmmnRspns.stsfdg02)">필수 항목입니다.</div>
                                    </td>
                                    <td class="tac" v-for="row in codeData.stsfdg">
                                        <label>
                                            <input type="radio" name="stsfdg02" v-value="row.code" onclick="javascript:vues.intro.setValue(this);"></input>
                                        </label>
                                    </td>
                                </tr>
                                <tr v-if="model.tbSurveyQestnrCmmn.stsfdg03 === true">
                                    <th>3</th>
                                    <td>
                                        <span>전주대학교의 교육환경에 대해 만족하십니까?</span>
                                        <div class="valid-checker" v-if="showValidChecker(model.tbSurveyCmmnRspns.stsfdg03)">필수 항목입니다.</div>
                                    </td>
                                    <td class="tac" v-for="row in codeData.stsfdg">
                                        <label>
                                            <input type="radio" name="stsfdg03" v-value="row.code" onclick="javascript:vues.intro.setValue(this);"></input>
                                        </label>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="actions actions-footer" style="text-align: center; padding:10px;">
                <button type="button" class="btn btn-default btn-next pull-right" name="_proceed" value="등록" onclick="javascript:vues.intro.update();">다음 <i class="fa fa-angle-right"><!----></i></button>
                <div style="clear: both;"><!----></div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
    var vues = {};

    CommonUtil.contextPath = "${pageContext.request.contextPath}";

    vues.intro = new Vue({
        el: '#intro',
        data: {
            codeData: {},
            surveyId: <c:out value="${id}" />,
            model: {
                tbSurveyQestnrCmmn: {},
                tbSurveyCmmnRspns: {}
            },
            checked: false,
        },
        directives: {
            value: {
                bind: function(el, binding, vnode) {
                    $(el).val(binding.value);
                }
            }
        },
        computed: {
        },
        mounted: function() {
            var vue = this;

            var requestCodeList = [];

            requestCodeList.push({ key: "[CMMN_SEXDSTN]" });
            requestCodeList.push({ key: "[CMMN_AREA]" });
            requestCodeList.push({ key: "[CMMN_GRADE]" });
            requestCodeList.push({ key: "[CMMN_CGHMY]" });
            requestCodeList.push({ key: "[CMMN_STSFDG]" });

            CommonUtil.loadCodeData(requestCodeList, function(result) {
                vue.codeData = {
                    sexdstn: result["[CMMN_SEXDSTN]"].list,
                    area: result["[CMMN_AREA]"].list,
                    grade: result["[CMMN_GRADE]"].list,
                    cghmy: result["[CMMN_CGHMY]"].list,
                    stsfdg: result["[CMMN_STSFDG]"].list
                };

                vue.read();
            });
        },
        methods: {
            // 값 유효성 표시
            showValidChecker: function(value) {
                if (this.checked !== true) {
                    return false;
                }

                if (value == null || value == "") {
                    return true;
                }

                return false;
            },
            // 값 셋팅
            setValue: function(el) {
                var $el = $(el);

                Vue.set(this.model.tbSurveyCmmnRspns, $el.attr("name"), $el.val());
            },
            // 조회
            read: function() {
                var vue = this;

                CommonUtil.axios()
                .get("/surveys/private/PrivateSurveyIntro/" + vue.surveyId)
                .then(function(response) {
                    vue.model = response.data;

                    for (var name in vue.model.tbSurveyCmmnRspns) {
                        $('input:radio[name="' + name + '"][value="' + vue.model.tbSurveyCmmnRspns[name] + '"]').prop("checked", true);
                    }
                })
                ["catch"](function(error) {
                    CommonUtil.showAxiosError(error);
                });
            },
            // 저장
            update: function() {
                var vue = this;

                vue.checked = true;

                vue.$nextTick(function() {
                    if ($('.valid-checker').length > 0) {
                        return;
                    }

                    CommonUtil.axios()
                    .put("/surveys/private/PrivateSurveyIntro/" + vue.surveyId, vue.model)
                    .then(function(response) {
                        window.location.href = "1";
                    })
                    ["catch"](function(error) {
                        CommonUtil.showAxiosError(error);
                    });
                });
            }
        }
    });
    </script>
</div>
