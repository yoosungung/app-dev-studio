<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
 그룹 관리 Mapper
 -->
<mapper namespace="kr.ac.jj.survey.application.groupmanage.mapper.GroupManageMapper">

    <!-- 목록 조회 -->
    <select id="selectList" resultType="kr.ac.jj.shared.infrastructure.framework.core.support.collection.CamelKeyMap">
        <![CDATA[
            SELECT TSG.SURVEY_GROUP_ID
                 , TSG.GROUP_NM
                 , TSG.GROUP_DC
                 , FN_CODE_NAME('CNRS_YN', TSG.CNRS_YN, #{$var.userLocale}, #{$var.defaultLocale}, NULL) AS CNRS_YN_NM
                 , TSG.REGIST_DT
                 , FN_PERSON_NAME(TSG.REGIST_PSN_ID, #{$var.userLocale}) AS REGIST_PSN_NM
                 , (SELECT COUNT(*)
                    FROM   TB_SURVEY_GROUP_PERSON TSGP
                    WHERE  TSGP.SURVEY_GROUP_ID = TSG.SURVEY_GROUP_ID
                   ) AS PERSON_CO
            FROM   TB_SURVEY_GROUP TSG
            WHERE  1 = 1
        ]]>

        <!-- 그룹명 -->
        <if test='search != null and search.groupNm != null and search.groupNm != ""'>
            <![CDATA[
            AND    UPPER(TSG.GROUP_NM) LIKE CONCAT_WS('', '%', UPPER(#{search.groupNm}), '%')
            ]]>
        </if>
    </select>

    <!-- 사람(대상자) 목록 검색 -->
    <select id="selectPersonSearchList" resultType="kr.ac.jj.shared.infrastructure.framework.core.support.collection.CamelKeyMap">
        <![CDATA[
            SELECT TCP.PERSON_ID
                 , TCP.EMPL_NO
                 , TCP.KOREAN_NM
                 , TCP.EMAIL_ADRES
                 , TCD.DEPT_NM
                 , CASE WHEN TSGP.PERSON_ID IS NOT NULL THEN '1' ELSE '0' END AS GROUP_PERSON_YN
            FROM   TB_COM_PERSON TCP
                   LEFT JOIN TB_COM_DEPT TCD ON TCD.DEPT_ID = TCP.DEPT_ID
                   LEFT JOIN TB_SURVEY_GROUP_PERSON TSGP ON TSGP.SURVEY_GROUP_ID = #{search.surveyGroupId} AND TSGP.PERSON_ID = TCP.PERSON_ID
            WHERE  TCP.PERSON_SE = 'I'
            AND    TCP.EMAIL_ADRES IS NOT NULL
        ]]>

        <!-- 이름 -->
        <if test='search != null and search.personNm != null and search.personNm != ""'>
            <![CDATA[
            AND    (UPPER(TCP.KOREAN_NM) LIKE CONCAT_WS('', '%', UPPER(#{search.personNm}), '%') OR
                    UPPER(TCP.ENGL_NM) LIKE CONCAT_WS('', '%', UPPER(#{search.personNm}), '%') OR
                    UPPER(TCP.CHCRT_NM) LIKE CONCAT_WS('', '%', UPPER(#{search.personNm}), '%')
                   )
            ]]>
        </if>

        <!-- 조직명 -->
        <if test='search != null and search.deptNm != null and search.deptNm != ""'>
            <![CDATA[
            AND    UPPER(TCD.DEPT_NM) LIKE CONCAT_WS('', '%', UPPER(#{search.deptNm}), '%')
            ]]>
        </if>
    </select>

    <!-- 조직 트리 목록 조회 -->
    <select id="selectDeptTreeList" resultType="kr.ac.jj.shared.infrastructure.framework.core.support.collection.CamelKeyMap">
        <![CDATA[
            SELECT TCD.DEPT_ID
                 , TCD.UPPER_DEPT_ID
                 , TCD.DEPT_CODE
                 , TCD.DEPT_NM
                 , IFNULL(TCP.PERSON_CO, 0) AS TOT_PERSON_CO
                 , IFNULL(TSGP.PERSON_CO, 0) AS ADIT_PERSON_CO
            FROM   TB_COM_DEPT TCD
                   LEFT JOIN (
                        SELECT TCP.DEPT_ID
                             , COUNT(*) AS PERSON_CO
                        FROM   TB_COM_PERSON TCP
                        WHERE  TCP.EMAIL_ADRES IS NOT NULL
                        GROUP BY TCP.DEPT_ID
                   ) TCP ON TCP.DEPT_ID = TCD.DEPT_ID
                   LEFT JOIN (
                        SELECT TCP.DEPT_ID
                             , COUNT(*) AS PERSON_CO
                        FROM   TB_COM_PERSON TCP
                               INNER JOIN TB_SURVEY_GROUP_PERSON TSGP ON TSGP.SURVEY_GROUP_ID = #{surveyGroupId} AND TSGP.PERSON_ID = TCP.PERSON_ID
                        GROUP BY TCP.DEPT_ID
                   ) TSGP ON TSGP.DEPT_ID = TCD.DEPT_ID
            ORDER BY TCD.DEPT_LEVEL, TCD.DEPT_NM
        ]]>
    </select>

</mapper>
