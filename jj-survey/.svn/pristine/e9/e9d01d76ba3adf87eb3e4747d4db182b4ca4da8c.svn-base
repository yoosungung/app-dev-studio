<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
 설문지 관리 Mapper
 -->
<mapper namespace="kr.ac.jj.survey.application.qestnrmanage.mapper.QuestionnaireManageMapper">

    <!-- 목록 조회 -->
    <select id="selectList" resultType="kr.ac.jj.shared.infrastructure.framework.core.support.collection.CamelKeyMap">
        <![CDATA[
            SELECT TSQ.SURVEY_QESTNR_ID
                 , SD.NAME
                 , TSR.SURVEY_REALM_NM
                 , SD.STATUS
                 , ${$var.getCodeData("[SURVEY_DEFINITION_STATUS]", "SD.STATUS", "SD.STATUS")} AS STATUS_NAME
                 , SD.START_DT
                 , SD.END_DT
                 , TSQ.CNRS_YN
                 , FN_CODE_NAME('CNRS_YN', TSQ.CNRS_YN, #{$var.userLocale}, #{$var.defaultLocale}, NULL) AS CNRS_YN_NM
                 , (SELECT COUNT(1)
                    FROM   SURVEY_DEFINITION_PAGE SDP
                    WHERE  SDP.SURVEY_DEFINITION_ID = TSQ.SURVEY_DEFINITION_ID
                   ) AS DEFINITION_PAGE_CO
                 , (SELECT COUNT(1)
                    FROM   SURVEY_DEFINITION_PAGE SDP
                           INNER JOIN SURVEY_QUESTION SQ ON SQ.SURVEY_DEFINITION_PAGE_ID = SDP.ID
                    WHERE  SDP.SURVEY_DEFINITION_ID = TSQ.SURVEY_DEFINITION_ID
                   ) AS QUESTION_CO
            FROM   TB_SURVEY_QESTNR TSQ
                   INNER JOIN TB_SURVEY_REALM TSR ON TSQ.SURVEY_REALM_ID = TSR.SURVEY_REALM_ID
                   INNER JOIN SURVEY_DEFINITION SD ON SD.ID = TSQ.SURVEY_DEFINITION_ID
            WHERE  1 = 1
        ]]>

        <!-- 설문 이름 -->
        <if test='search != null and search.name != null and search.name != ""'>
            <![CDATA[
            AND    UPPER(SD.NAME) LIKE CONCAT_WS('', '%', UPPER(#{search.name}), '%')
            ]]>
        </if>

        <!-- 설문 분야 -->
        <if test='search != null and search.surveyRealmId != null and search.surveyRealmId != ""'>
            <![CDATA[
            AND    TSQ.SURVEY_REALM_ID = #{search.surveyRealmId}
            ]]>
        </if>
    </select>

    <!-- 템플릿 검색 목록 조회 -->
    <select id="selectTemplateSearchList" resultType="kr.ac.jj.shared.infrastructure.framework.core.support.collection.CamelKeyMap">
        <![CDATA[
            SELECT TST.SURVEY_TMPLAT_ID
                 , SD.NAME
                 , TSR.SURVEY_REALM_NM
                 , TST.TMPLAT_STTUS
                 , FN_CODE_NAME('TMPLAT_STTUS', TST.TMPLAT_STTUS, #{$var.userLocale}, #{$var.defaultLocale}, NULL) AS TMPLAT_STTUS_NM
            FROM   TB_SURVEY_TMPLAT TST
                   INNER JOIN TB_SURVEY_REALM TSR ON TST.SURVEY_REALM_ID = TSR.SURVEY_REALM_ID
                   INNER JOIN SURVEY_DEFINITION SD ON SD.ID = TST.SURVEY_DEFINITION_ID
            WHERE  TST.TMPLAT_STTUS = '1'
        ]]>

        <!-- 템플릿 이름 -->
        <if test='search != null and search.name != null and search.name != ""'>
            <![CDATA[
            AND    UPPER(SD.NAME) LIKE CONCAT_WS('', '%', UPPER(#{search.name}), '%')
            ]]>
        </if>

        <!-- 설문 분야 -->
        <if test='search != null and search.surveyRealmId != null and search.surveyRealmId != ""'>
            <![CDATA[
            AND    TST.SURVEY_REALM_ID = #{search.surveyRealmId}
            ]]>
        </if>
    </select>

    <!-- 이전 설문지 검색 목록 조회 -->
    <select id="selectPrevSurveySearchList" resultType="kr.ac.jj.shared.infrastructure.framework.core.support.collection.CamelKeyMap">
        <![CDATA[
            SELECT TSQ.SURVEY_QESTNR_ID
                 , SD.NAME
                 , TSR.SURVEY_REALM_NM
                 , SD.STATUS
                 , ${$var.getCodeData("[SURVEY_DEFINITION_STATUS]", "SD.STATUS", "SD.STATUS")} AS STATUS_NAME
                 , SD.START_DT
                 , SD.END_DT
                 , TSQ.CNRS_YN
                 , FN_CODE_NAME('CNRS_YN', TSQ.CNRS_YN, #{$var.userLocale}, #{$var.defaultLocale}, NULL) AS CNRS_YN_NM
            FROM   TB_SURVEY_QESTNR TSQ
                   INNER JOIN TB_SURVEY_REALM TSR ON TSQ.SURVEY_REALM_ID = TSR.SURVEY_REALM_ID
                   INNER JOIN SURVEY_DEFINITION SD ON SD.ID = TSQ.SURVEY_DEFINITION_ID
            WHERE  1 = 1
        ]]>

        <!-- 설문 이름 -->
        <if test='search != null and search.name != null and search.name != ""'>
            <![CDATA[
            AND    UPPER(SD.NAME) LIKE CONCAT_WS('', '%', UPPER(#{search.name}), '%')
            ]]>
        </if>

        <!-- 설문 분야 -->
        <if test='search != null and search.surveyRealmId != null and search.surveyRealmId != ""'>
            <![CDATA[
            AND    TSQ.SURVEY_REALM_ID = #{search.surveyRealmId}
            ]]>
        </if>
    </select>

</mapper>
