<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 출신 지역 분포 Mapper -->
<mapper namespace="kr.ac.jj.dashboard.application.dashboard.spread.mapper.SpreadMapper">

    <!-- 출신 지역 분포 리스트 조회 -->
    <select id="readList" resultType="kr.ac.jj.shared.infrastructure.framework.core.support.collection.CamelKeyMap">
    with tbl as (
        select IPSY_HIGH_LOCATION_DO_SUMMARY as location
                , sum(case when IPSY_GUBUN_NAME_SUMMARY != '기타지역' then cnt else 0 end) cnt_all
                , sum(case IPSY_GUBUN_NAME_SUMMARY when '학생부종합' then cnt else 0 end) as cnt_jong
                , sum(case IPSY_GUBUN_NAME_SUMMARY when '학생부교과' then cnt else 0 end) as cnt_gyo
                , sum(case IPSY_GUBUN_NAME_SUMMARY when '정시' then cnt else 0 end) as cnt_jung
                , sum(case when IPSY_GUBUN_NAME_SUMMARY not in ('기타지역','학생부종합','학생부교과','정시') then cnt else 0 end) cnt_all2
                from ( select
                                         CASE
                                                WHEN IPSY_GUBUN_NAME LIKE '%(학생부교과)' THEN '학생부교과'
                                                WHEN IPSY_GUBUN_NAME LIKE '%(학생부종합)' THEN '학생부종합'
                                                WHEN IPSY_GUBUN_NAME LIKE '수시%'         THEN '수시'
                                                WHEN IPSY_GUBUN_NAME LIKE '추가%'         THEN'추가'
                                                WHEN IPSY_GUBUN_NAME LIKE '정시%'         THEN '정시'
                                                ELSE IPSY_GUBUN_NAME
                                            END IPSY_GUBUN_NAME_SUMMARY /* 입학 구분별 이름 */
                                        , case when IPSY_HIGH_LOCATION_DO is null or IPSY_HIGH_LOCATION_DO = '기타' then '기타지역' else IPSY_HIGH_LOCATION_DO end as IPSY_HIGH_LOCATION_DO_SUMMARY
                                        /*
                                        , CASE
                                                WHEN IPSY_HIGH_LOCATION_DO IN ('서울') THEN '서울'
                                                WHEN IPSY_HIGH_LOCATION_DO IN ('경기') THEN '경기'
                                                WHEN IPSY_HIGH_LOCATION_DO IN ('광주') THEN '광주'
                                                WHEN IPSY_HIGH_LOCATION_DO IN ('전남') THEN '전남'
                                                WHEN IPSY_HIGH_LOCATION_DO IN ('대전') THEN '대전'
                                                WHEN IPSY_HIGH_LOCATION_DO IN ('충남') THEN '충남'
                                                WHEN IPSY_HIGH_LOCATION_DO IN ('전북') THEN '전북'
                                                #WHEN IPSY_HIGH_LOCATION_DO = '전북' THEN CASE WHEN IPSY_HIGH_LOCATION_SIGUNGU = '전주시' THEN '전주시' ELSE '전라북도' END
                                                WHEN IPSY_HIGH_LOCATION_DO IS NULL THEN '미상지역'
                                                ELSE '기타지역'
                                            END  IPSY_HIGH_LOCATION_DO_SUMMARY *//* 지역 도별 이름 */
                                            , count(*) cnt
                                        from DW_IPSYMAST a
                                        group by IPSY_GUBUN_NAME, ipsy_high_location_do
                ) t
                where IPSY_HIGH_LOCATION_DO_SUMMARY != '기타지역'
                group by IPSY_HIGH_LOCATION_DO_SUMMARY
                order by case IPSY_HIGH_LOCATION_DO_SUMMARY when '전북' then 1 else 2 end, IPSY_HIGH_LOCATION_DO_SUMMARY
        )
        select t.location
            , cnt_all, cnt_jong, cnt_gyo, cnt_jung
            , round(cnt_all/c1*100,1)*10 as cnt_all_rate
            , round(cnt_jong/c2*100,1)*10 as cnt_jong_rate
            , round(cnt_gyo/c3*100,1)*10 as cnt_gyo_rate
            , round(cnt_jung/c4*100,1)*10 as cnt_jung_rate
            , round(cnt_all2/c5*100,1)*10 as cnt_all2_rate
        from (
            select *
            , (select sum(cnt_all) from tbl) c1
            , (select sum(cnt_jong) from tbl) c2
            , (select sum(cnt_gyo) from tbl) c3
            , (select sum(cnt_jung) from tbl) c4
            , (select sum(cnt_all2) from tbl) c5
            from tbl
            group by location
        ) t
    </select>
</mapper>
