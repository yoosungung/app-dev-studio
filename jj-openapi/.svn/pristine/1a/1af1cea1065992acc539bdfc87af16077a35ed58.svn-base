package kr.ac.jj.openapi.application.apilist.handler;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.LinkedHashMap;
import java.util.Map;

import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;

import kr.ac.jj.openapi.application.apilist.model.ApiRequest;
import kr.ac.jj.shared.infrastructure.framework.core.foundation.exception.BaseException;
import kr.ac.jj.shared.infrastructure.framework.core.support.io.util.IOUtil;
import kr.ac.jj.shared.infrastructure.framework.web.context.request.RequestContextUtil;
import kr.ac.jj.shared.infrastructure.grid.handler.GridDataWriter;

public class ApiDataWriterToCsv2 extends GridDataWriter {

    //private final PrintWriter responseWriter;
    private final FileWriter fileWriter;
    private final File tempFile;

    public ApiDataWriterToCsv2(ApiRequest apiRequest) {
        super(apiRequest);

        tempFile = new File("F:\\test\\csv.txt");

        HttpServletResponse response = RequestContextUtil.getResponse();

        response.setCharacterEncoding("utf-8");
        response.setContentType("application/octet-stream");
        response.setHeader("Content-Disposition", "attachment; filename=" + tempFile + "");

        try {
            this.fileWriter = new FileWriter(tempFile);
            //this.responseWriter = response.getWriter();
        } catch (IOException e) {
            throw new BaseException(e);
        }
    }

    @Override
    public void writeRowData(Map<String, Object> rowData) {
        Map<String, Object> map = new LinkedHashMap<String, Object>();

        map.putAll(rowData);

        int index = 1;
        if((int) map.get("rn") == 1 ) {
            for(Map.Entry<String, Object> elem : map.entrySet()) {

                if(StringUtils.equals(map.keySet().stream().findFirst().get(), elem.getKey())) {
                    try {
                        this.fileWriter.write(elem.getKey());
                    } catch (IOException e) {
                        // TODO Auto-generated catch block
                        e.printStackTrace();
                    }
                    //responseWriter.print(elem.getKey());
                } else if(index == map.keySet().size()){
                    try {
                        this.fileWriter.write("," + elem.getKey() +"\r\n");
                    } catch (IOException e) {
                        // TODO Auto-generated catch block
                        e.printStackTrace();
                    }
                    //responseWriter.println("," + elem.getKey());
                } else {
                    try {
                        this.fileWriter.write("," + elem.getKey());
                    } catch (IOException e) {
                        e.printStackTrace();
                    }
                    //responseWriter.print("," + elem.getKey());
                }
                index++;
            }
        }

        index = 1;
        for(Map.Entry<String, Object> elem : map.entrySet()) {
            if(StringUtils.equals(map.keySet().stream().findFirst().get(), elem.getKey())) {
                try {
                    this.fileWriter.write((String) elem.getValue());
                } catch (IOException e) {
                    e.printStackTrace();
                }
                //responseWriter.print(elem.getValue());
            } else if(index == map.keySet().size()){
                try {
                    this.fileWriter.write("," + elem.getValue() +"\r\n");
                } catch (IOException e) {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                }
                //responseWriter.println("," + elem.getValue());
            } else {
                try {
                    this.fileWriter.write("," + elem.getValue());
                } catch (IOException e) {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                }
                //responseWriter.print("," + elem.getValue());
            }
            index++;
        }

    }

    @Override
    public void writeEnd(boolean success) {
        try {
            fileWriter.flush();
        } catch (IOException e) {
            tempFile.delete();
        }finally {
            IOUtil.closeQuietly(fileWriter);

            if (!success) {
                tempFile.delete();
            }
        }
    }

}
