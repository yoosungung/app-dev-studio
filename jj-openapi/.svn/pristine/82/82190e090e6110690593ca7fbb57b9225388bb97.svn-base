<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
 키 발급 관리 Mapper
 -->
<mapper namespace="kr.ac.jj.openapi.application.openapi.keymanage.mapper.KeyManageMapper">

    <!-- 목록 조회 -->
    <select id="selectList" resultType="kr.ac.jj.shared.infrastructure.framework.core.support.collection.CamelKeyMap">
        <![CDATA[
            SELECT TASK.SVC_KEY_ID
                 , TASK.SVC_ID
                 , TASK.API_KEY
                 , TASK.APPLCNT_ID
                 , FN_PERSON_NAME(TASK.APPLCNT_ID, #{$var.userLocale}) AS APPLCNT_NM
                 , TASK.RQSTDT
                 , TASK.CALL_CO_PDAY
                 , TASK.KEY_USE_PD_BEGIN
                 , TASK.KEY_USE_PD_END
                 , TASK.STTUS
                 , ${$var.getCodeData("[KEY_STTUS]", "TASK.STTUS", "TASK.STTUS")} AS STTUS_NM
                 , TASK.REQUST_MATTER
                 , TASK.EXMNT_PSN_ID
                 , FN_PERSON_NAME(TASK.EXMNT_PSN_ID, #{$var.userLocale}) AS EXMNT_PSN_NM
                 , TASK.EXMNT_DT
                 , TASK.EXMNT_RESULT
                 , TCP.EMPL_NO
                 , TCP.EMAIL_ADRES
                 , TCP.TLPHON_NO
            FROM   TB_API_SVC_KEY TASK
                   INNER JOIN TB_COM_PERSON TCP ON TASK.APPLCNT_ID = TCP.PERSON_ID
            WHERE  1 = 1
        ]]>

        <!-- 검색어 -->
        <if test='search != null and search.searchText != null and search.searchText != ""'>
            <![CDATA[
            AND    (UPPER(TSCG.CODE_GROUP) LIKE CONCAT_WS('', '%', UPPER(#{search.searchText}), '%') OR
                    UPPER(TSCG.CODE_GROUP_NM) LIKE CONCAT_WS('', '%', UPPER(#{search.searchText}), '%') OR
                    UPPER(TSCG.CODE_GROUP_DC) LIKE CONCAT_WS('', '%', UPPER(#{search.searchText}), '%') OR
                    EXISTS (SELECT 1
                            FROM   TB_SYS_CODE_VALUE T1
                            WHERE  T1.CODE_GROUP_ID = TSCG.CODE_GROUP_ID
                            AND    (UPPER(T1.CODE_VALUE) LIKE CONCAT_WS('', '%', UPPER(#{search.searchText}), '%') OR
                                    UPPER(T1.CODE_VALUE_NM) LIKE CONCAT_WS('', '%', UPPER(#{search.searchText}), '%') OR
                                    UPPER(T1.CODE_VALUE_DC) LIKE CONCAT_WS('', '%', UPPER(#{search.searchText}), '%')
                                   )
                           )
                   )
            ]]>
        </if>

        <!-- 이메일 -->
        <if test='search != null and search.searchEmail != null and search.searchEmail != ""'>
            <![CDATA[
            AND    UPPER(TCP.EMAIL_ADRES) LIKE CONCAT_WS('', '%', UPPER(#{search.searchEmail}), '%')
            ]]>
        </if>

        <!-- 핸드폰 -->
        <if test='search != null and search.searchPhone != null and search.searchPhone != ""'>
            <![CDATA[
            AND    UPPER(TCP.TLPHON_NO) LIKE CONCAT_WS('', '%', UPPER(#{search.searchPhone}), '%')
            ]]>
        </if>

        <!-- 핸드폰숫자 -->
        <if test='search != null and search.searchPhoneNumberOnly != null and search.searchPhoneNumberOnly != ""'>
            <![CDATA[
             OR    UPPER(REGEXP_REPLACE(TCP.TLPHON_NO,'[^0-9]','')) LIKE CONCAT_WS('', '%', UPPER(#{search.searchPhoneNumberOnly}), '%')
             ]]>
        </if>

        <!-- 전체 기간 -->
        <if test='!search.wholedate'>
            <!-- 사용여부 -->
            <if test='search != null and search.keySttus != null and search.keySttus != ""'>
                <![CDATA[
                AND    TASK.STTUS = #{search.keySttus}
                ]]>
            </if>

            <!-- 기간 설정 시작일 -->
            <if test ='search != null and search.keyUsePdBegin != "" and search.keyUsePdBegin != null'>
                <choose>
                    <when test = 'search.keyDateSttus == "A"'>
                        <![CDATA[
                        AND    TASK.EXMNT_DT >= #{search.keyUsePdBegin}
                        ]]>
                    </when>
                    <when test = 'search.keyDateSttus == "C"'>
                        <![CDATA[
                        AND    TASK.RQSTDT >= #{search.keyUsePdBegin}
                        ]]>
                    </when>
                    <when test = 'search.keyDateSttus == "R"'>
                        <![CDATA[
                        AND    TASK.KEY_USE_PD_BEGIN >= #{search.keyUsePdBegin}
                        ]]>
                    </when>
                    <!-- 전체인데 시작 기간만 잇을때 -->
                    <when
                        test='search.keyUsePdEnd == null or search.keyUsePdEnd == ""'>
                         <![CDATA[
                            AND TASK.RQSTDT >= #{search.keyUsePdBegin} OR
                            TASK.EXMNT_DT >= #{search.keyUsePdBegin} OR
                            TASK.KEY_USE_PD_BEGIN>=#{search.keyUsePdBegin}
                         ]]>
                    </when>
                </choose>
            </if>

            <!-- 기간 설정 종료일 -->
            <if test ='search != null and search.keyUsePdEnd != "" and search.keyUsePdEnd != null'>
                <choose>
                    <when test = 'search.keyDateSttus == "A"'>
                        <![CDATA[
                        AND    TASK.EXMNT_DT <= #{search.keyUsePdEnd}
                        ]]>
                    </when>
                    <when test = 'search.keyDateSttus == "C"'>
                        <![CDATA[
                        AND    TASK.RQSTDT <= #{search.keyUsePdEnd}
                        ]]>
                    </when>
                    <when test = 'search.keyDateSttus == "R"'>
                        <![CDATA[
                        AND    TASK.KEY_USE_PD_END <= #{search.keyUsePdEnd}
                        ]]>
                    </when>
                    <!-- 전체인데 마감 기간만 잇을때 -->
                    <when test='search.keyUsePdBegin == null or search.keyUsePdBegin ==""'>
                         <![CDATA[
                            AND TASK.RQSTDT <= #{search.keyUsePdEnd} OR
                            TASK.EXMNT_DT <= #{search.keyUsePdEnd} OR
                            TASK.KEY_USE_PD_END <= #{search.keyUsePdEnd}
                         ]]>
                    </when>
                </choose>
            </if>

             <!-- 전체인데 시작 마감기간다잇을때 -->
            <if test='search.keyDateSttus == null or search.keyDateSttus == ""'>
                <choose>
                    <when test='search.keyUsePdBegin != null and search.keyUsePdBegin != "" and search.keyUsePdEnd != null and search.keyUsePdEnd != ""'>
                         <![CDATA[
                            AND (TASK.RQSTDT BETWEEN #{search.keyUsePdBegin} AND #{search.keyUsePdEnd}) OR
                            (TASK.EXMNT_DT BETWEEN #{search.keyUsePdBegin} AND #{search.keyUsePdEnd}) OR
                            TASK.KEY_USE_PD_BEGIN>=#{search.keyUsePdBegin} AND TASK.KEY_USE_PD_END<=#{search.keyUsePdEnd}
                         ]]>
                    </when>
                </choose>
            </if>
        </if>

    </select>

</mapper>
