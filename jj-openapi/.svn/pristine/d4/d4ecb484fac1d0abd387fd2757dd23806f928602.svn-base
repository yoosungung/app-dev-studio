package kr.ac.jj.openapi.application.openapi.apilist.handler;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletResponse;

import org.springframework.web.servlet.view.json.MappingJackson2JsonView;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

import kr.ac.jj.shared.infrastructure.framework.core.foundation.exception.BaseException;
import kr.ac.jj.shared.infrastructure.framework.web.context.request.RequestContextUtil;

public class ApiDataWriterToJson extends ApiDataWriter{

    private final PrintWriter responseWriter;
    private final ObjectMapper objectMapper;

    private String dataSetComma;
    private String dataRowComma;

    public ApiDataWriterToJson() {
        HttpServletResponse response = RequestContextUtil.getResponse();

        response.setCharacterEncoding("utf-8");
        response.setContentType(MappingJackson2JsonView.DEFAULT_CONTENT_TYPE);

        try {
            this.responseWriter = response.getWriter();
        } catch (IOException e) {
            throw new BaseException(e);
        }

        this.objectMapper = new ObjectMapper();

        this.responseWriter.print("{");

        this.dataSetComma = "";
    }

    @Override
    public void writeStart() {
        this.responseWriter.println(this.dataSetComma + "\"" + this.getKey() + "\":");
        this.responseWriter.print("[");

        this.dataSetComma = ",";
        this.dataRowComma = "";
    }

    @Override
    public void writeRowData(Map<String, Object> rowData) {
        try {
            String jsonString = this.objectMapper.writeValueAsString(rowData);
            this.responseWriter.println(this.dataRowComma + jsonString);
        } catch (JsonProcessingException e) {
            throw new BaseException(e);
        }

        this.dataRowComma = ",";
    }

    @Override
    public void writeEnd(boolean success) {
        if (success) {
            this.responseWriter.println("]}");
        }
    }

    @Override
    public List<Map<String, Object>> getResultList(boolean success) {
        if (success) {
            this.responseWriter.print("}");
        }

        return null;
    }

}
